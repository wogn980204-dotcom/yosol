<!-- 동일한 HTML 기본 구조 생략 -->

<script>
  const plane = document.querySelector('#animPlane');
  const marker = document.querySelector('#nftMarker');
  const totalFrames = 23;
  const textures = [];
  let interval = null;
  let current = 0;

  const loader = new THREE.TextureLoader();

  // 텍스처 미리 로딩
  for (let i = 0; i < totalFrames; i++) {
    const path = `frames/frame_${String(i).padStart(3, '0')}.png`;
    textures.push(loader.load(path));
  }

  function startAnimation() {
    // plane이 THREE 객체로 초기화될 때까지 대기
    const mesh = plane.getObject3D('mesh');
    if (!mesh) {
      // 아직 초기화되지 않았으면 재시도
      setTimeout(startAnimation, 100);
      return;
    }

    plane.setAttribute('visible', 'true');
    if (interval) return;

    interval = setInterval(() => {
      if (textures[current]) {
        mesh.material.map = textures[current];
        mesh.material.needsUpdate = true;
      }
      current = (current + 1) % totalFrames;
    }, 100);
  }

  function stopAnimation() {
    clearInterval(interval);
    interval = null;
    current = 0;
    plane.setAttribute('visible', 'false');
  }

  marker.addEventListener('markerFound', startAnimation);
  marker.addEventListener('markerLost', stopAnimation);

  window.addEventListener('load', () => {
    document.querySelector('.arjs-loader').style.display = 'none';
  });
</script>
