<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Pro Component Fix</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <script>
        AFRAME.registerComponent('transparent-animator', {
            schema: {
                totalFrames: {type: 'int', default: 22},
                fps: {type: 'number', default: 15}
            },

            init: function () {
                this.loader = new THREE.TextureLoader();
                this.textures = [];
                this.loadedCount = 0;
                this.currentIdx = 0;
                this.lastTime = 0;
                this.mesh = null;
                
                // 루트 경로 자동 계산
                const rootPath = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);

                // 텍스처 미리 로드
                for (let i = 0; i < this.data.totalFrames; i++) {
                    const url = `${rootPath}frames/frame_${String(i).padStart(3, '0')}.png`;
                    this.loader.load(url, (tex) => {
                        // [핵심] 텍스처 설정 하드코딩
                        tex.encoding = THREE.sRGBEncoding;
                        tex.minFilter = THREE.NearestFilter;
                        tex.magFilter = THREE.NearestFilter;
                        tex.generateMipmaps = false; // 흐림 방지
                        this.textures[i] = tex;
                        this.loadedCount++;
                    });
                }

                // 메쉬 객체 확보를 위한 이벤트 리스너
                this.el.addEventListener('object3dset', () => {
                    this.mesh = this.el.getObject3D('mesh');
                    if(this.mesh) this.applyMaterialFix();
                });
            },

            // [핵심] 재질 강제 고정 함수
            applyMaterialFix: function () {
                if (!this.mesh) return;
                const mat = this.mesh.material;
                
                // 엔진이 덮어쓰지 못하도록 강력하게 선언
                mat.transparent = true;
                mat.opacity = 1.0;
                mat.alphaTest = 0.5; // 투명도 0.5 이하는 잘라냄 (검은 박스 제거)
                mat.depthWrite = false; // 배경을 가리지 않음 (실루엣 제거 핵심)
                mat.depthTest = false;  // 항상 맨 앞에 그려짐
                mat.side = THREE.DoubleSide;
                mat.blending = THREE.NormalBlending;
                mat.needsUpdate = true;
            },

            // 매 프레임 실행되는 루프 (Tick)
            tick: function (time, timeDelta) {
                // 리소스가 다 로딩되지 않았으면 대기
                if (this.loadedCount < this.data.totalFrames) return;
                
                // 마커가 보일 때만 실행
                if (!this.el.object3D.visible) return;

                // FPS 제어 (15fps = 약 66ms)
                const interval = 1000 / this.data.fps;
                if (time - this.lastTime >= interval) {
                    if (this.mesh && this.textures[this.currentIdx]) {
                        // 텍스처 교체
                        this.mesh.material.map = this.textures[this.currentIdx];
                        
                        // [방어 코드] 텍스처 교체 시 재질 설정이 풀리는 것을 매번 방지
                        this.applyMaterialFix(); 

                        this.currentIdx = (this.currentIdx + 1) % this.data.totalFrames;
                        this.lastTime = time;
                    }
                }
            }
        });
    </script>
</head>

<body style="margin: 0; overflow: hidden;">
    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; color: #fff; z-index: 9999;"
         onclick="this.style.display='none'">
         화면을 터치하면 시작합니다.
    </div>

    <a-scene
        embedded
        vr-mode-ui="enabled: false;"
        renderer="antialias: false; alpha: true; precision: mediump; logarithmicDepthBuffer: false;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

        <a-nft id="nft-target" type="nft" url="" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="2">
            <a-plane 
                position="100 0 -280" 
                rotation="-90 0 0" 
                width="450" height="450"
                material="shader: flat; transparent: true; opacity: 0;"
                transparent-animator="totalFrames: 22; fps: 15">
            </a-plane>
        </a-nft>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // NFT 경로 설정 (외부 스크립트 최소화)
        const nft = document.querySelector('#nft-target');
        const rootPath = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
        nft.setAttribute('url', rootPath + 'AR');
    </script>
</body>
</html>
