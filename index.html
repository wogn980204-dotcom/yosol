<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Pro Final Fix</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <script>
        AFRAME.registerComponent('transparent-animator', {
            schema: {
                totalFrames: {type: 'int', default: 22},
                fps: {type: 'number', default: 15}
            },

            init: function () {
                this.loader = new THREE.TextureLoader();
                this.textures = [];
                this.loadedCount = 0;
                this.currentIdx = 0;
                this.lastTime = 0;
                this.mesh = null; // 메쉬를 담을 변수
                
                const rootPath = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);

                // 텍스처 로드
                for (let i = 0; i < this.data.totalFrames; i++) {
                    const url = `${rootPath}frames/frame_${String(i).padStart(3, '0')}.png`;
                    this.loader.load(url, (tex) => {
                        tex.encoding = THREE.sRGBEncoding;
                        tex.minFilter = THREE.NearestFilter;
                        tex.magFilter = THREE.NearestFilter;
                        tex.generateMipmaps = false; 
                        this.textures[i] = tex;
                        this.loadedCount++;
                    });
                }
            },

            // [핵심] 메쉬를 찾고 설정을 강제하는 함수
            setupMesh: function() {
                const mesh = this.el.getObject3D('mesh');
                if (!mesh) return false; // 아직 없으면 다음 프레임에 다시 시도

                this.mesh = mesh;
                const mat = this.mesh.material;
                
                // [설정 강제 주입]
                mat.transparent = true;
                mat.opacity = 1.0;     // 투명도 강제 복구
                mat.alphaTest = 0.5;   // 검은 실루엣 제거 핵심
                mat.depthWrite = false;
                mat.depthTest = false; 
                mat.side = THREE.DoubleSide;
                mat.map = this.textures[0]; // 첫 프레임 즉시 할당
                mat.needsUpdate = true;
                
                return true;
            },

            tick: function (time, timeDelta) {
                // 1. 메쉬가 아직 확보되지 않았다면 매 프레임 시도
                if (!this.mesh) {
                    if (!this.setupMesh()) return;
                }

                // 2. 텍스처 로딩 대기
                if (this.loadedCount < this.data.totalFrames) return;

                // 3. FPS 제어 (15fps)
                const interval = 1000 / this.data.fps;
                if (time - this.lastTime >= interval) {
                    // 애니메이션 실행
                    if (this.textures[this.currentIdx]) {
                        this.mesh.material.map = this.textures[this.currentIdx];
                        
                        // [안전장치] 매 프레임마다 핵심 설정 재확인
                        this.mesh.material.alphaTest = 0.5;
                        this.mesh.material.depthWrite = false;
                        
                        this.currentIdx = (this.currentIdx + 1) % this.data.totalFrames;
                        this.lastTime = time;
                    }
                }
            }
        });
    </script>
</head>

<body style="margin: 0; overflow: hidden;">
    <div id="loading" style="position: absolute; top:0; left:0; width:100%; height:100%; background:#000; color:#fff; display:flex; justify-content:center; align-items:center; z-index:9999;">
        시스템 초기화 중...
    </div>

    <a-scene
        embedded
        vr-mode-ui="enabled: false;"
        renderer="antialias: false; alpha: true; precision: mediump; logarithmicDepthBuffer: false;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

        <a-nft id="nft-target" type="nft" url="" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="2">
            <a-plane 
                position="100 0 -280" 
                rotation="-90 0 0" 
                width="450" height="450"
                material="shader: flat; transparent: true; side: double;"
                transparent-animator="totalFrames: 22; fps: 15">
            </a-plane>
        </a-nft>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const nft = document.querySelector('#nft-target');
        const loaderDiv = document.querySelector('#loading');
        
        // 경로 설정
        const rootPath = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
        nft.setAttribute('url', rootPath + 'AR');

        // NFT 마커 발견 시 로딩창 제거 및 렌더링 보정
        nft.addEventListener('markerFound', () => {
            loaderDiv.style.display = 'none';
        });
    </script>
</body>
</html>
