<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>AR Consumer - Stable Version</title>

  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    /* 화면 잘림 및 스크롤 방지 */
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
    
    /* AR.js 생성 요소 강제 교정 */
    #arjs-video {
      width: 100vw !important;
      height: 100vh !important;
      object-fit: cover !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      z-index: -1;
    }

    .a-canvas {
      width: 100% !important;
      height: 100% !important;
      top: 0 !important;
      left: 0 !important;
    }

    #loader {
      position: fixed; inset: 0; background: #000;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      color: #fff; z-index: 9999; font-family: sans-serif;
    }
  </style>
</head>

<body>
  <div id="loader">
    <p id="msg">AR Engine Initializing...</p>
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="antialias: true; alpha: true; precision: mediump;"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; displayWidth: 1280; displayHeight: 720; canvasWidth: 1280; canvasHeight: 720;">

    <a-nft
      id="nft-target"
      type="nft"
      url="./AR/markername" 
      smooth="true" smoothCount="10">

      <a-plane
        id="animPlane"
        position="0 0 0"
        rotation="-90 0 0"
        width="150" height="150"
        visible="false"
        material="transparent: true; side: double;">
      </a-plane>
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // 상태 추적을 위한 로그
    window.addEventListener('nft-image-loaded', () => {
      document.getElementById('msg').innerText = "Marker Data Found. Loading textures...";
      console.log("NFT Data Found");
    });

    window.addEventListener('arjs-nft-loaded', () => {
      document.getElementById('loader').style.display = 'none';
      console.log("AR.js Fully Ready");
    });

    // 프레임 애니메이션 컴포넌트
    AFRAME.registerComponent('canvas-frame-anim', {
      schema: {
        total: { type: 'int', default: 22 },
        fps: { type: 'number', default: 15 },
        path: { type: 'string', default: './frames/' }
      },
      init: function () {
        this.imgs = [];
        this.idx = 0;
        this.last = 0;
        this.active = false;
        
        this.canv = document.createElement('canvas');
        this.ctx = this.canv.getContext('2d');
        this.tex = new THREE.CanvasTexture(this.canv);

        for (let i = 0; i < this.data.total; i++) {
          const img = new Image();
          img.src = `${this.data.path}frame_${String(i).padStart(3, '0')}.png`;
          this.imgs.push(img);
        }

        this.el.sceneEl.addEventListener('markerFound', () => {
          this.active = true;
          this.el.setAttribute('visible', 'true');
        });
        this.el.sceneEl.addEventListener('markerLost', () => {
          this.active = false;
          this.el.setAttribute('visible', 'false');
        });

        this.el.addEventListener('model-loaded', () => {
          const mesh = this.el.getObject3D('mesh');
          if (mesh) mesh.material.map = this.tex;
        });
      },
      tick: function (t) {
        if (!this.active) return;
        if (t - this.last > (1000 / this.data.fps)) {
          const img = this.imgs[this.idx];
          if (img && img.complete) {
            if (this.canv.width !== img.width) {
              this.canv.width = img.width;
              this.canv.height = img.height;
            }
            this.ctx.clearRect(0, 0, this.canv.width, this.canv.height);
            this.ctx.drawImage(img, 0, 0);
            this.tex.needsUpdate = true;
          }
          this.idx = (this.idx + 1) % this.data.total;
          this.last = t;
        }
      }
    });

    document.querySelector('#animPlane').setAttribute('canvas-frame-anim', '');
  </script>
</body>
</html>
