<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>AR - 소비자용 (최적화 버전)</title>

  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }

    /* AR.js가 생성하는 비디오를 전체화면으로 강제 고정 */
    video {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
      z-index: -1; /* 모든 UI와 AR 요소 뒤로 */
    }

    /* 상단 상태 점 (빨강: 미인식, 초록: 인식) */
    #statusIndicator {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ff0000;
      box-shadow: 0 0 8px rgba(0,0,0,0.5);
      z-index: 10;
      transition: background 0.3s ease;
    }

    /* 로딩 화면 */
    .arjs-loader {
      height: 100%; width: 100%; position: absolute; top: 0; left: 0;
      background-color: rgba(0, 0, 0, 0.8); z-index: 9999;
      display: flex; justify-content: center; align-items: center;
    }
    .arjs-loader div { text-align: center; color: white; }
  </style>
</head>

<body>
  <div class="arjs-loader">
    <div>AR 데이터를 불러오는 중... (잠시만 기다려주세요)</div>
  </div>

  <div id="statusIndicator"></div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="antialias: true; alpha: true; precision: highp; colorManagement: true;"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

    <a-nft
      id="nft-target"
      type="nft"
      url="YOUR_NFT_MARKER_PATH_HERE" 
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5">

      <a-plane
        id="animPlane"
        position="0 0 0"
        rotation="-90 0 0"
        width="150" 
        height="150"
        visible="false"
        material="transparent: true; side: double;">
      </a-plane>
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // 1. Canvas 기반 프레임 애니메이션 컴포넌트
    AFRAME.registerComponent('canvas-frame-anim', {
      schema: {
        totalFrames: { type: 'int', default: 22 },
        fps: { type: 'number', default: 15 },
        framesPath: { type: 'string', default: 'frames/' },
        filePrefix: { type: 'string', default: 'frame_' },
        fileExt: { type: 'string', default: '.png' }
      },

      init: function () {
        this.images = [];
        this.loadedCount = 0;
        this.currentIdx = 0;
        this.lastTime = 0;
        this.playing = false;
        
        // 캔버스 생성
        this.canvas = document.createElement('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.texture = new THREE.CanvasTexture(this.canvas);

        // 이미지 미리 로드
        for (let i = 0; i < this.data.totalFrames; i++) {
          const img = new Image();
          const fileName = `${this.data.filePrefix}${String(i).padStart(3, '0')}${this.data.fileExt}`;
          img.src = this.data.framesPath + fileName;
          img.onload = () => {
            this.loadedCount++;
            if (this.loadedCount === 1) {
              this.canvas.width = img.width;
              this.canvas.height = img.height;
            }
          };
          this.images.push(img);
        }

        // 마커 이벤트 리스너
        const nftMarker = document.querySelector('#nft-target');
        const statusDot = document.querySelector('#statusIndicator');

        nftMarker.addEventListener('markerFound', () => {
          this.playing = true;
          this.el.setAttribute('visible', 'true');
          statusDot.style.background = '#00ff00';
        });

        nftMarker.addEventListener('markerLost', () => {
          this.playing = false;
          this.el.setAttribute('visible', 'false');
          statusDot.style.background = '#ff0000';
        });

        // 메쉬 및 재질 설정
        this.el.addEventListener('model-loaded', () => this.setupMaterial());
        this.setupMaterial();
      },

      setupMaterial: function() {
        const mesh = this.el.getObject3D('mesh');
        if (mesh) {
          mesh.material.map = this.texture;
          mesh.material.transparent = true;
          mesh.material.alphaTest = 0.1;
          mesh.material.needsUpdate = true;
        }
      },

      tick: function (time, timeDelta) {
        if (!this.playing || this.loadedCount < this.data.totalFrames) return;

        if (time - this.lastTime > (1000 / this.data.fps)) {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          this.ctx.drawImage(this.images[this.currentIdx], 0, 0);
          this.texture.needsUpdate = true;
          
          this.currentIdx = (this.currentIdx + 1) % this.data.totalFrames;
          this.lastTime = time;
        }
      }
    });

    // 컴포넌트 수동 할당
    document.querySelector('#animPlane').setAttribute('canvas-frame-anim', '');

    // 로더 제거 이벤트
    window.addEventListener('arjs-nft-loaded', () => {
       document.querySelector('.arjs-loader').style.display = 'none';
    });
  </script>
</body>
</html>
