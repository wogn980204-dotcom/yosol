<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>AR - 마커 진단용 (모바일 테스트)</title>

  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <!-- AR.js: 운영 환경에서는 릴리스 태그(버전 고정) 사용 권장 -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
    #overlay {
      position: absolute;
      left: 8px;
      top: 8px;
      z-index: 10000;
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      max-width: 92%;
    }
    #overlay .row { display:flex; gap:8px; align-items:center; margin-bottom:6px; flex-wrap:wrap; }
    .badge { background: rgba(255,255,255,0.06); padding:6px 10px; border-radius:8px; color:#fff; }
    #controls { position: absolute; right: 8px; top: 8px; z-index:10000; }
    #controls button { padding:8px 10px; margin-left:6px; border-radius:6px; border:none; }
  </style>
</head>

<body>
  <div id="overlay" aria-live="polite">
    <div class="row">
      <div id="nftStatus" class="badge">NFT: 대기</div>
      <div id="patternStatus" class="badge">Hiro: 대기</div>
      <div id="framesStatus" class="badge">프레임: 0/0</div>
      <div id="animStatus" class="badge">애니: 대기</div>
    </div>
    <div style="font-size:12px; opacity:0.9;">
      테스트 방법:
      1) 'Hiro 테스트'를 눌러 화면 오른쪽(또는 인쇄된) Hiro 마커를 비춰보세요.
      2) Hiro가 감지되면 빨간 박스가 나타나야 합니다(AR.js 동작 확인).
      3) NFT가 작동하지 않으면 NFT 경로(AR 폴더, descriptor 파일) 또는 파일 접근 문제일 가능성 큽니다.
    </div>
  </div>

  <div id="controls">
    <button id="hideUI">로더 숨기기</button>
    <button id="testHiro">Hiro 테스트</button>
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="antialias: true; alpha: true; precision: highp; logarithmicDepthBuffer: true; colorManagement: true;"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

    <!-- NFT 마커 (실제 NFT 경로로 바꿔야 함) -->
    <a-nft id="nft-target" type="nft" url="" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="2">
      <!-- 영상/애니를 표시할 평면 (프레임 애니메이터 적용) -->
      <a-plane
        id="nftPlane"
        position="0 0 0"
        rotation="-90 0 0"
        width="1" height="1"
        material="shader: flat; transparent: true; side: double;"
        transparent-animator="totalFrames: 22; fps: 15; framesPath: frames/">
      </a-plane>
    </a-nft>

    <!-- 패턴(프리셋) 마커: Hiro 테스트용.
         모바일에서 바로 테스트하려면 Hiro 마커를 다른 화면에 띄우거나 인쇄해서 비추세요. -->
    <a-marker id="hiroMarker" preset="hiro" emitevents="true" visible="false">
      <!-- Hiro가 잡히면 이 박스가 보입니다(디버깅용) -->
      <a-box id="hiroDebugBox" position="0 0.5 0" depth="0.3" height="0.3" width="0.3" color="red" visible="false"></a-box>
      <a-text id="hiroLabel" value="Hiro Detected" position="0 0.95 0" align="center" visible="false"></a-text>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // UI 요소
    const nftStatus = document.getElementById('nftStatus');
    const patternStatus = document.getElementById('patternStatus');
    const framesStatus = document.getElementById('framesStatus');
    const animStatus = document.getElementById('animStatus');
    const hideUIbtn = document.getElementById('hideUI');
    const testHiroBtn = document.getElementById('testHiro');

    hideUIbtn.addEventListener('click', () => {
      document.getElementById('overlay').style.display = 'none';
    });

    // Helper to update badges
    function setBadge(el, text, color) {
      el.textContent = text;
      if (color) el.style.background = color;
    }

    // Transparent animator 컴포넌트 (간단화, 프레임 일부만 있어도 작동)
    AFRAME.registerComponent('transparent-animator', {
      schema: {
        totalFrames: { type: 'int', default: 22 },
        fps: { type: 'number', default: 15 },
        framesPath: { type: 'string', default: 'frames/' },
        filePrefix: { type: 'string', default: 'frame_' },
        fileExt: { type: 'string', default: '.png' }
      },

      init: function () {
        this.loader = new THREE.TextureLoader();
        if (this.loader && typeof this.loader.setCrossOrigin === 'function') {
          try { this.loader.setCrossOrigin('anonymous'); } catch (e) {}
        }

        this.textures = new Array(this.data.totalFrames);
        this.loadedCount = 0;
        this.currentIdx = 0;
        this.lastTime = performance.now();
        this.mesh = null;
        this.anyLoaded = false;

        // rootPath
        const rootPath = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
        this._rootPath = rootPath;

        // load frames (onError allowed)
        for (let i=0;i<this.data.totalFrames;i++){
          const fname = `${this.data.filePrefix}${String(i).padStart(3,'0')}${this.data.fileExt}`;
          const url = rootPath + this.data.framesPath + fname;
          this.loader.load(
            url,
            (tex) => {
              try { tex.encoding = THREE.sRGBEncoding; } catch(e){}
              tex.minFilter = THREE.LinearFilter;
              tex.magFilter = THREE.LinearFilter;
              tex.generateMipmaps = false;
              this.textures[i] = tex;
              this.loadedCount++;
              this.anyLoaded = true;
              framesStatus.textContent = `프레임: ${this.loadedCount}/${this.data.totalFrames}`;
            },
            undefined,
            (err) => {
              this.textures[i] = null;
              this.loadedCount++;
              framesStatus.textContent = `프레임: ${this.loadedCount}/${this.data.totalFrames} (일부 실패)`;
            }
          );
        }
      },

      setupMesh: function() {
        const mesh = this.el.getObject3D('mesh');
        if (!mesh) return false;
        this.mesh = mesh;
        const mat = Array.isArray(mesh.material) ? mesh.material[0] : mesh.material;
        if (!mat) return false;
        mat.transparent = true;
        mat.alphaTest = 0.1;
        mat.depthWrite = false;
        mat.depthTest = true;
        mesh.renderOrder = 1;

        const first = this.textures.find(t=>!!t);
        if (first) { mat.map = first; if(mat.map) mat.map.needsUpdate = true; }
        mat.needsUpdate = true;
        return true;
      },

      tick: function (time) {
        if (!this.mesh) {
          if (!this.setupMesh()) return;
        }
        // if no frames loaded, do nothing
        if (!this.anyLoaded) {
          animStatus.textContent = '애니: 프레임 없음';
          return;
        }

        // only animate if the NFT marker is visible (we rely on markerFound handlers in outer scope to hide/show UI)
        // but here we still animate when plane is visible in scene.
        const interval = 1000 / this.data.fps;
        if (time - this.lastTime >= interval) {
          // find next available texture
          let attempts = 0;
          let tex = null;
          while (attempts < this.data.totalFrames) {
            const idx = (this.currentIdx + attempts) % this.data.totalFrames;
            if (this.textures[idx]) { tex = this.textures[idx]; this.currentIdx = (idx+1)%this.data.totalFrames; break; }
            attempts++;
          }
          if (tex && this.mesh && this.mesh.material) {
            const mat = Array.isArray(this.mesh.material) ? this.mesh.material[0] : this.mesh.material;
            mat.map = tex;
            if (mat.map) mat.map.needsUpdate = true;
            animStatus.textContent = '애니: 재생 중';
          } else {
            animStatus.textContent = '애니: 프레임 없음';
          }
          this.lastTime = time;
        }
      }
    });

    // Set NFT URL (수정 필요: 실제 descriptor 폴더/파일 경로로 변경)
    (function() {
      const nft = document.querySelector('#nft-target');
      const rootPath = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
      const nftUrl = rootPath + 'AR/'; // << 실제 AR descriptor 폴더 또는 descriptor 파일 경로로 수정하세요
      nft.setAttribute('url', nftUrl);
      nftStatus.textContent = `NFT: URL 설정됨`;
      // Attach markerFound/markerLost on the nft element
      nft.addEventListener('markerFound', () => {
        nftStatus.textContent = 'NFT: 감지';
        // show the NFT plane (it is child of a-nft so should show automatically if attached)
        const plane = document.getElementById('nftPlane');
        if (plane) plane.setAttribute('visible', 'true');
      });
      nft.addEventListener('markerLost', () => {
        nftStatus.textContent = 'NFT: 미검출';
      });
    })();

    // Hiro marker handlers for quick test
    (function() {
      const hiro = document.querySelector('#hiroMarker');
      const box = document.getElementById('hiroDebugBox');
      const label = document.getElementById('hiroLabel');

      hiro.addEventListener('markerFound', () => {
        patternStatus.textContent = 'Hiro: 감지';
        // show debug box so user can see immediate feedback
        box.setAttribute('visible', 'true');
        label.setAttribute('visible', 'true');
        // also make the box pulse so it's obvious
        box.setAttribute('animation', 'property: position; to: 0 0.7 0; dir: alternate; dur: 500; loop: true');
      });

      hiro.addEventListener('markerLost', () => {
        patternStatus.textContent = 'Hiro: 미검출';
        box.setAttribute('visible', 'false');
        label.setAttribute('visible', 'false');
        box.removeAttribute('animation');
      });

      // Button to focus user on Hiro test
      testHiroBtn.addEventListener('click', () => {
        // Ensure overlay visible to see status badges
        document.getElementById('overlay').style.display = 'block';
        patternStatus.textContent = 'Hiro: 대기';
        alert('Hiro 마커를 다른 화면(또는 인쇄물)에 띄우고 카메라로 비춰보세요.\n(Hiro 마커: https://raw.githubusercontent.com/jeromeetienne/AR.js/master/three.js/examples/marker-training/examples/pattern-files/marker-hiro.png)');
      });
    })();

    // 추가 안내: 모바일에서 AR이 시작되지 않으면 확인할 것들
    // 1) HTTPS로 서비스되고 있는지 (getUserMedia는 보안 컨텍스트 필요)
    // 2) 카메라 권한 허용 여부
    // 3) NFT descriptor(.iset/.fset 등) 파일이 nft.setAttribute('url', ...) 경로에 존재하는지
    // 4) frames 폴더와 파일명(frame_000.png ~ frame_021.png)이 정확한지
    // 5) 서버가 적절한 MIME과 CORS 헤더로 파일을 제공하는지

    // 쉬운 진단 요���:
    // - Hiro 박스를 비췄을 때 빨간 박스가 보이면 AR.js/카메라/트래킹 자체는 정상.
    // - Hiro 작동하지만 NFT는 작동하지 않으면 => NFT 경로/descriptor 문제 (경로 확인, 파일 존재, https, CORS)
    // - Hiro도 작동하지 않으면 => 카메라 권한, https, 또는 AR.js 로딩 문제
  </script>
</body>
</html>
