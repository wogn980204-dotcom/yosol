<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Pro Shader Fix</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <script>
        AFRAME.registerComponent('transparent-animator', {
            schema: {
                totalFrames: {type: 'int', default: 22},
                fps: {type: 'number', default: 15}
            },

            init: function () {
                this.loader = new THREE.TextureLoader();
                this.textures = [];
                this.loadedCount = 0;
                this.currentIdx = 0;
                this.lastTime = 0;
                this.mesh = null;
                
                const rootPath = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);

                for (let i = 0; i < this.data.totalFrames; i++) {
                    const url = `${rootPath}frames/frame_${String(i).padStart(3, '0')}.png`;
                    this.loader.load(url, (tex) => {
                        tex.encoding = THREE.sRGBEncoding;
                        // [수정 1] 부드러운 표현을 위해 LinearFilter로 변경하되, 셰이더로 투명도 조절
                        tex.minFilter = THREE.LinearFilter;
                        tex.magFilter = THREE.LinearFilter;
                        tex.generateMipmaps = false; 
                        this.textures[i] = tex;
                        this.loadedCount++;
                    });
                }
            },

            setupMesh: function() {
                const mesh = this.el.getObject3D('mesh');
                if (!mesh) return false;

                this.mesh = mesh;
                const mat = this.mesh.material;
                
                // [핵심 수정 2] 마테리얼 설정 및 셰이더 주입
                mat.transparent = true;
                mat.opacity = 1.0;
                mat.side = THREE.DoubleSide;
                mat.depthWrite = false; // 배경을 가리지 않도록 설정
                mat.depthTest = false;  // 항상 가장 앞에 보이도록 설정
                
                // 렌더링 순서를 가장 나중으로 미룸
                mesh.renderOrder = 9999;

                // [중요] 셰이더 조작을 통해 투명 픽셀을 물리적으로 제거 (discard)
                // 이미 주입된 적이 없을 때만 실행
                if (!mat.userData.shaderInjected) {
                    mat.onBeforeCompile = (shader) => {
                        shader.fragmentShader = shader.fragmentShader.replace(
                            `#include <color_fragment>`,
                            `#include <color_fragment>
                             // 알파값이 0.1 미만인 어두운 투명 영역은 아예 그리지 않음
                             if ( diffuseColor.a < 0.1 ) discard;
                            `
                        );
                    };
                    mat.userData.shaderInjected = true;
                }

                mat.map = this.textures[0];
                mat.needsUpdate = true;
                
                return true;
            },

            tick: function (time, timeDelta) {
                if (!this.mesh) {
                    if (!this.setupMesh()) return;
                }

                if (this.loadedCount < this.data.totalFrames) return;

                const interval = 1000 / this.data.fps;
                if (time - this.lastTime >= interval) {
                    if (this.textures[this.currentIdx]) {
                        this.mesh.material.map = this.textures[this.currentIdx];
                        // 텍스처 변경 시 업데이트 플래그 필요
                        this.mesh.material.needsUpdate = true;
                        
                        this.currentIdx = (this.currentIdx + 1) % this.data.totalFrames;
                        this.lastTime = time;
                    }
                }
            }
        });
    </script>
</head>

<body style="margin: 0; overflow: hidden;">
    <div id="loading" style="position: absolute; top:0; left:0; width:100%; height:100%; background:#000; color:#fff; display:flex; justify-content:center; align-items:center; z-index:9999;">
        시스템 초기화 중... 마커를 비춰주세요.
    </div>

    <a-scene
        embedded
        vr-mode-ui="enabled: false;"
        renderer="antialias: true; alpha: true; precision: highp; logarithmicDepthBuffer: true; colorManagement: true;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

        <a-nft id="nft-target" type="nft" url="" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="2">
            <a-plane 
                position="100 0 -280" 
                rotation="-90 0 0" 
                width="450" height="450"
                material="shader: flat; transparent: true; side: double;"
                transparent-animator="totalFrames: 22; fps: 15">
            </a-plane>
        </a-nft>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const nft = document.querySelector('#nft-target');
        const loaderDiv = document.querySelector('#loading');
        const rootPath = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
        nft.setAttribute('url', rootPath + 'AR');

        nft.addEventListener('markerFound', () => {
            loaderDiv.style.display = 'none';
        });
    </script>
</body>
</html>
